<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>შეკვეთების მართვის სისტემა (გაფართოებული)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    
    <style>
        :root {
            /* Light Mode Colors - Reverted to more vibrant/original material design */
            --primary-color: #4285F4; /* Google Blue */
            --primary-dark-color: #1A73E8;
            --accent-color: #34A853; /* Google Green */
            --accent-dark-color: #2E8B49;
            --warning-color: #FBBC05; /* Google Yellow */
            --error-color: #EA4335; /* Google Red */
            --text-color: #202124; /* Dark grey for primary text */
            --light-text-color: #5F6368; /* Medium grey for secondary text */
            --background-light: #F8F9FA; /* Lightest background */
            --surface-color: #FFFFFF; /* Card/Container background */
            --border-color: #DADCE0;
            --shadow-1: 0 2px 4px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.08); /* Stronger but subtle shadow */
            --shadow-2: 0 4px 8px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.12); /* Slightly deeper shadow */
            --shadow-3: 0 8px 16px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.16); /* Deepest shadow */


            /* Dark Mode Colors (keeping these as they are not the primary issue) */
            --dark-primary-color: #8AB4F8; /* Lighter blue for dark mode */
            --dark-primary-dark-color: #AECBFA;
            --dark-accent-color: #81C995;
            --dark-accent-dark-color: #6AA87A;
            --dark-warning-color: #FDD663;
            --dark-error-color: #F28B82;
            --dark-text-color: #E8EAED; /* Light grey for primary text */
            --dark-light-text-color: #BDC1C6; /* Medium light grey for secondary text */
            --dark-background-light: #202124; /* Darkest background */
            --dark-surface-color: #2F3034; /* Dark card/container background */
            --dark-border-color: #5F6368;
        }

        /* Dark Mode overrides */
        body.dark-mode {
            background-color: var(--dark-background-light);
            color: var(--dark-text-color);
        }

        body.dark-mode .card {
            background-color: var(--dark-surface-color);
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.4); /* Darker shadow for dark mode */
        }

        body.dark-mode .header h1,
        body.dark-mode .filters h3,
        body.dark-mode .stat-card .number {
            color: var(--dark-text-color);
        }

        body.dark-mode .light-text-color, /* For specific elements that use this */
        body.dark-mode .stat-card h4,
        body.dark-mode #fileName,
        body.dark-mode .date-column,
        body.dark-mode th {
            color: var(--dark-light-text-color);
        }

        /* Dark mode for filter labels */
        body.dark-mode .filter-group label,
        body.dark-mode .address-toggle-group label,
        body.dark-mode .date-filter-checkbox-group label {
            color: var(--dark-text-color); /* Make labels brighter in dark mode */
            font-weight: 700; /* Ensure boldness */
        }


        body.dark-mode .sync-indicator {
            background-color: var(--dark-accent-color);
            color: var(--dark-text-color); /* Ensure text is visible */
        }
        body.dark-mode .sync-indicator.syncing {
            background-color: var(--dark-warning-color);
            color: var(--dark-text-color); /* Ensure text is visible */
        }
        body.dark-mode .sync-indicator.error {
            background-color: var(--dark-error-color);
            color: var(--dark-text-color); /* Ensure text is visible */
        }

        body.dark-mode .button-primary {
            background-color: var(--dark-primary-color);
        }
        body.dark-mode .button-primary:hover {
            background-color: var(--dark-primary-dark-color);
        }

        body.dark-mode .button-danger {
            background-color: var(--dark-error-color);
        }
        body.dark-mode .button-danger:hover {
            background-color: #CF6679; /* Darker red for dark mode hover */
        }

        body.dark-mode .view-toggle {
            background-color: var(--dark-surface-color);
        }
        body.dark-mode .view-btn {
            color: var(--dark-light-text-color);
        }
        body.dark-mode .view-btn.active {
            background-color: var(--dark-primary-color);
            color: var(--dark-text-color); /* Use dark text color for active button */
        }
        body.dark-mode .view-btn:hover:not(.active) {
            background-color: #3C4043; /* Slightly lighter dark background for hover */
            color: var(--dark-text-color);
        }
        
        body.dark-mode .filter-group input, 
        body.dark-mode .filter-group select,
        body.dark-mode .date-filter-group input[type="date"],
        body.dark-mode .date-filter-group input[type="datetime-local"] {
            background-color: #3C4043; /* Darker input background */
            border-color: var(--dark-border-color);
            color: var(--dark-text-color);
        }
        body.dark-mode .filter-group input:focus, 
        body.dark-mode .filter-group select:focus,
        body.dark-mode .date-filter-group input[type="date"]:focus,
        body.dark-mode .date-filter-group input[type="datetime-local"]:focus {
            outline: none;
            border-color: var(--dark-primary-color);
            box-shadow: 0 0 0 2px rgba(138, 180, 248, 0.2); /* Lighter focus ring */
        }

        body.dark-mode th {
            background-color: #3C4043; /* Darker header background */
        }

        body.dark-mode tbody tr:hover {
            background-color: rgba(138, 180, 248, 0.1); /* Lighter blue hover for dark mode */
        }

        body.dark-mode .status-collect {
            background-color: var(--dark-warning-color);
            color: var(--dark-text-color);
        }
        body.dark-mode .status-collected {
            background-color: var(--dark-accent-color);
            color: var(--dark-text-color);
        }
        body.dark-mode .status-problematic { /* NEW: Problematic status for dark mode */
            background-color: var(--dark-error-color);
            color: var(--dark-text-color);
        }

        body.dark-mode .empty-state h3 {
            color: var(--dark-text-color);
        }
        body.dark-mode .empty-state p {
            color: var(--dark-light-text-color);
        }

        body.dark-mode .notification.success {
            background-color: var(--dark-accent-color);
        }
        body.dark-mode .notification.error {
            background-color: var(--dark-error-color);
        }

        /* Comment Icon Styling */
        .comment-icon {
            margin-left: 8px;
            vertical-align: middle;
            font-size: 18px; /* Slightly larger icon */
            cursor: pointer;
            color: var(--primary-color); /* Google Blue for the icon */
            transition: color 0.2s ease;
        }
        body.dark-mode .comment-icon {
            color: var(--dark-primary-color);
        }
        .comment-icon:hover {
            color: var(--primary-dark-color);
        }
        body.dark-mode .comment-icon:hover {
            color: var(--dark-primary-dark-color);
        }
        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Above notifications */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow-3);
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            position: relative; /* For close button positioning */
        }
        body.dark-mode .modal-content {
            background-color: var(--dark-surface-color);
        }

        .modal-content h3 {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        body.dark-mode .modal-content h3 {
            color: var(--dark-text-color);
        }

        .modal-content p {
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-color);
            margin-bottom: 5px; /* Reduced margin to make space for date */
            white-space: pre-wrap; /* Preserve line breaks */
        }
        body.dark-mode .modal-content p {
            color: var(--dark-light-text-color);
        }

        /* NEW: Comment timestamp style */
        .modal-content .comment-timestamp {
            font-size: 13px;
            color: var(--light-text-color);
            margin-top: 10px;
            display: block; /* Ensure it's on its own line */
        }
        body.dark-mode .modal-content .comment-timestamp {
            color: var(--dark-light-text-color);
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            color: var(--light-text-color);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close-btn:hover {
            color: var(--text-color);
        }
        body.dark-mode .modal-close-btn {
            color: var(--dark-light-text-color);
        }
        body.dark-mode .modal-close-btn:hover {
            color: var(--dark-text-color);
        }

        /* Styles for date filter checkboxes */
        .date-filter-checkbox-group {
            display: flex;
            gap: 20px; /* Space between checkboxes */
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .date-filter-checkbox-group div {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .date-filter-checkbox-group input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            position: relative;
            transition: background-color 0.2s, border-color 0.2s;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .date-filter-checkbox-group input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .date-filter-checkbox-group input[type="checkbox"]:checked::after {
            content: '✔'; /* Checkmark symbol */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* Dark mode for checkboxes */
        body.dark-mode .date-filter-checkbox-group input[type="checkbox"] {
            border-color: var(--dark-primary-color);
        }
        body.dark-mode .date-filter-checkbox-group input[type="checkbox"]:checked {
            background-color: var(--dark-primary-color);
            border-color: var(--dark-primary-color);
        }
        
        /* General styles, kept similar to previous Material Design update */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--background-light);
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: var(--shadow-1);
            padding: 24px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Smooth transition for theme change */
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            color: var(--text-color);
            font-size: 28px;
            font-weight: 500;
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--surface-color);
            background-color: var(--accent-color); /* Default: Synced (Green) */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sync-indicator.syncing {
            background-color: var(--warning-color); /* Syncing (Yellow) */
        }

        .sync-indicator.error {
            background-color: var(--error-color); /* Error (Red) */
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.8); }
        }

        .upload-section {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            box-shadow: var(--shadow-1); /* Added shadow to buttons */
        }

        .button:hover {
            box-shadow: var(--shadow-2); /* Deeper shadow on hover */
        }

        .button:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .button-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .button-primary:hover {
            background-color: var(--primary-dark-color);
        }

        .button-danger {
            background-color: var(--error-color);
            color: white;
        }

        .button-danger:hover {
            background-color: #C53929; /* Darker red */
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-1); /* Added shadow */
        }

        .file-input-label:hover {
            background-color: var(--primary-dark-color);
            box-shadow: var(--shadow-2); /* Deeper shadow on hover */
        }

        #fileName {
            color: var(--light-text-color);
            font-size: 14px;
            margin-left: 8px;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 8px;
            box-shadow: var(--shadow-1);
            width: fit-content;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .view-btn {
            background-color: transparent;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: var(--light-text-color);
            transition: all 0.2s ease;
            font-size: 15px;
        }

        .view-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-1); /* Shadow for active button */
        }

        .view-btn:hover:not(.active) {
            background-color: var(--background-light);
            color: var(--text-color);
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: var(--shadow-1);
            padding: 24px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;

            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100px;
        }

        .stat-card h4 {
            color: var(--light-text-color);
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Filters */
        .filters {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: var(--shadow-1);
            padding: 24px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .filters h3 {
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 20px;
            font-weight: 500;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        /* Styles for date inputs */
        .date-filter-group {
            display: flex;
            flex-direction: column;
            margin-top: 10px;
        }

        .date-filter-group label {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--light-text-color);
            font-size: 15px;
        }

        .date-filter-group input[type="date"],
        .date-filter-group input[type="datetime-local"] {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 15px;
            color: var(--text-color);
            background-color: var(--surface-color);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            min-height: 40px; /* Ensure consistent height */
        }
        .date-filter-group input[type="date"]:focus,
        .date-filter-group input[type="datetime-local"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2); /* Focus ring */
        }


        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 700; /* Make it bold */
            margin-bottom: 8px;
            color: var(--light-text-color); /* Kept same as other labels for light mode */
            font-size: 15px; /* Slightly larger */
        }

        .filter-group input, 
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 15px;
            color: var(--text-color);
            background-color: var(--surface-color);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            min-height: 40px; /* Ensure consistent height */
        }

        .filter-group input:focus, 
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2); /* Focus ring */
        }

        .clear-filters {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;

            background-color: var(--error-color);
            color: white;
            margin-top: 10px; /* Space from filters */
            box-shadow: var(--shadow-1); /* Added shadow */
        }
        .clear-filters:hover {
            background-color: #C53929;
            box-shadow: var(--shadow-2); /* Deeper shadow on hover */
        }

        /* Table */
        .table-container {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: var(--shadow-1);
            padding: 0; /* Table content will have its own padding */
            overflow: hidden; /* For rounded corners */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        /* Adjusted padding for larger records */
        th, td {
            padding: 18px 24px; /* Increased vertical padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        th {
            background-color: var(--background-light);
            font-weight: 500;
            color: var(--light-text-color);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: rgba(66, 133, 244, 0.05); /* Light blue hover */
        }

        /* Status Badge (retained for non-dropdown statuses or when not in editable view) */
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: default; /* Changed to default as it's no longer directly clickable to change status */
            transition: all 0.2s ease;
            display: inline-block;
            min-width: 120px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-1);
        }

        .status-collect {
            background-color: var(--warning-color);
            color: var(--text-color); /* Dark text for yellow background */
        }

        .status-collected {
            background-color: var(--accent-color);
            color: white;
        }
        .status-problematic {
            background-color: var(--error-color); /* Red for problematic */
            color: white;
        }

        /* No hover transform for static badges */
        .status-badge:hover {
            transform: none;
            box-shadow: var(--shadow-1); /* Retain original shadow */
        }


        .date-column {
            font-size: 13px;
            color: var(--light-text-color);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--light-text-color);
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--accent-color);
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            z-index: 1000;
            transform: translateX(calc(100% + 20px)); /* Hidden by default */
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
            box-shadow: var(--shadow-2);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.error {
            background-color: var(--error-color);
        }

        /* NEW: Address Column Hide/Unhide CSS */
        .address-column-header,
        .address-column-data {
            display: none !important; /* Important to override default table display */
        }

        /* NEW: Status Dropdown Styling */
        .status-dropdown {
            padding: 8px 16px; /* Match status badge padding */
            border: 1px solid var(--border-color);
            border-radius: 20px; /* Match status badge border-radius */
            font-size: 13px;
            font-weight: 600; /* Match status badge font-weight */
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block; /* Ensure it behaves like a badge */
            min-width: 120px; 
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-1); /* Apply shadow */

            appearance: none; /* Remove default select arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-repeat: no-repeat;
            background-position: right 8px center; /* Position custom arrow */
            background-size: 12px; /* Size custom arrow */
            
            /* Dynamic background image for arrow color based on theme */
            /* Note: getComputedStyle is needed for CSS variables in JS, but it won't work in pure HTML styles like this.
                     Fallback to direct hex values for arrow, or rely on browser default if complex CSS var needed.
                     For simplicity, using light/dark mode fixed hex colors here. */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%235F6368%22%20d%3D%22M287%2C146.2L146.2%2C287c-4.4%2C4.4-11.4%2C4.4-15.8%2C0L0%2C146.2c-4.4-4.4-4.4-11.4%2C0-15.8c4.4-4.4%2C11.4-4.4%2C15.8%2C0l122.6%2C122.6L271.2%2C130.4c4.4-4.4%2C11.4-4.4%2C15.8%2C0C291.4%2C134.8%2C291.4%2C141.8%2C287%2C146.2z%22%2F%3E%3C%2Fsvg%3E');
        }

        body.dark-mode .status-dropdown {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23BDC1C6%22%20d%3D%22M287%2C146.2L146.2%2C287c-4.4%2C4.4-11.4%2C4.4-15.8%2C0L0%2C146.2c-4.4-4.4-4.4-11.4%2C0-15.8c4.4-4.4%2C11.4-4.4%2C15.8%2C0l122.6%2C122.6L271.2%2C130.4c4.4-4.4%2C11.4-4.4%2C15.8%2C0C291.4%2C134.8%2C291.4%2C141.8%2C287%2C146.2z%22%2F%3E%3C%2Fsvg%3E');
        }

        .status-dropdown:hover {
            transform: translateY(-2px); /* Lift on hover */
            box-shadow: var(--shadow-2); /* Deeper shadow on hover */
        }
        /* Specific status colors for dropdowns */
        .status-collect.status-dropdown {
            background-color: var(--warning-color);
            color: var(--text-color); /* Dark text for yellow background */
            border-color: var(--warning-color); /* Match border to background */
        }

        .status-collected.status-dropdown {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        .status-problematic.status-dropdown {
            background-color: var(--error-color); /* Red for problematic */
            color: white;
            border-color: var(--error-color);
        }

        body.dark-mode .status-collect.status-dropdown {
            background-color: var(--dark-warning-color);
            color: var(--dark-text-color);
            border-color: var(--dark-warning-color);
        }
        body.dark-mode .status-collected.status-dropdown {
            background-color: var(--dark-accent-color);
            color: var(--dark-text-color);
            border-color: var(--dark-accent-color);
        }
        body.dark-mode .status-problematic.status-dropdown {
            background-color: var(--dark-error-color);
            color: var(--dark-text-color);
            border-color: var(--dark-error-color);
        }

        /* Ensure options within dropdown are styled for readability */
        .status-dropdown option {
            background-color: var(--surface-color);
            color: var(--text-color);
        }
        body.dark-mode .status-dropdown option {
            background-color: var(--dark-surface-color);
            color: var(--dark-text-color);
        }
        body.dark-mode .status-dropdown:hover {
            /* No specific dark mode hover for border/shadow as it's handled by generic .status-dropdown:hover */
        }

        /* Media Queries for responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                margin: 16px auto;
                gap: 16px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header h1 {
                font-size: 24px;
            }

            .upload-section {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }

            .file-input-wrapper, 
            .clear-data-btn,
            #darkModeToggle { 
                width: 100%;
            }
            .file-input-label, 
            .clear-data-btn,
            #darkModeToggle { 
                justify-content: center;
                width: 100%;
            }

            .view-toggle {
                width: 100%;
                justify-content: stretch;
            }
            .view-btn {
                flex: 1;
                text-align: center;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }
            .date-filter-checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
            .date-filter-group {
                margin-top: 0; /* Remove top margin on mobile if it creates too much space */
            }

            th, td {
                padding: 14px 16px; /* Slightly reduced padding for mobile */
            }
            
            .status-badge, .status-dropdown { /* Apply to dropdown too */
                min-width: unset;
                padding: 6px 12px;
                font-size: 12px;
            }
            .address-toggle-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .modal-content {
                padding: 20px;
            }
            .modal-content h3 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header card">
            <div>
                <h1>შეკვეთების მართვის სისტემა</h1>
                <div class="sync-indicator" id="syncIndicator">
                    <div class="sync-dot"></div>
                    <span id="syncStatus">ლოკალური მონაცემები</span>
                </div>
            </div>
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
                    <label for="fileInput" class="file-input-label">
                        <i class="material-icons">upload_file</i> Excel ფაილის ატვირთვა
                    </label>
                </div>
                <button class="button button-danger clear-data-btn" onclick="promptForClearData()">
                    <i class="material-icons">delete_forever</i> მონაცემების წაშლა
                </button>
                <button id="darkModeToggle" class="button button-primary" onclick="toggleDarkMode()">
                    <i class="material-icons" id="darkModeIcon">dark_mode</i> <span id="darkModeText">ბნელი რეჟიმი</span>
                </button>
                <span id="fileName"></span>
            </div>
        </div>

        <div class="view-toggle">
            <button class="view-btn active" onclick="switchView('dashboard')">
                <i class="material-icons">dashboard</i> დეშბორდი
            </button>
            <button class="view-btn" onclick="switchView('history')">
                <i class="material-icons">history</i> ისტორია
            </button>
            <button class="view-btn" onclick="switchView('data')">
                <i class="material-icons">storage</i> მონაცემები
            </button>
            <button class="view-btn" onclick="switchView('problematic')">
                <i class="material-icons">error</i> პრობლემურები
            </button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h4>სულ შეკვეთები</h4>
                <div class="number" id="totalOrders">0</div>
            </div>
            <div class="stat-card">
                <h4>ასაგროვებელი</h4>
                <div class="number" id="toCollectOrders">0</div>
            </div>
            <div class="stat-card">
                <h4>აგროვებული</h4>
                <div class="number" id="collectedOrders">0</div>
            </div>
            <div class="stat-card">
                <h4>საშუალო აგროვების სიჩქარე (24სთ)</h4>
                <div class="number" id="avgCollectionSpeed">N/A</div>
            </div>
        </div>

        <!-- Dashboard View Container -->
        <div id="dashboardViewContainer">
            <div class="filters card">
                <h3>ფილტრები</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterOrder">შეკვეთა</label>
                        <input type="text" id="filterOrder" placeholder="ძებნა შეკვეთის მიხედვით">
                    </div>
                    <div class="filter-group">
                        <label for="filterReceiver">მიმღები</label>
                        <input type="text" id="filterReceiver" placeholder="ძებნა მიმღების მიხედვით">
                    </div>
                    <div class="filter-group">
                        <label for="filterCourier">კურიერი</label>
                        <select id="filterCourier">
                            <option value="">ყველა კურიერი</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterStatus">სტატუსი</label>
                        <select id="filterStatus">
                            <option value="">ყველა სტატუსი</option>
                            <option value="ასაგროვებელი">ასაგროვებელი</option>
                            <option value="აგროვებული">აგროვებული</option>
                            <option value="პრობლემური">პრობლემური</option> <!-- NEW STATUS -->
                        </select>
                    </div>
                </div>
                <div class="address-toggle-group">
                    <input type="checkbox" id="toggleAddressColumn" checked>
                    <label for="toggleAddressColumn">მისამართის სვეტის ჩვენება</label>
                </div>
                <button class="button button-danger clear-filters" onclick="clearAllFilters()">
                    <i class="material-icons">filter_alt_off</i> ფილტრების გასუფთავება
                </button>
            </div>

            <div class="table-container">
                <div class="table-wrapper">
                    <table id="dataTableDashboard">
                        <thead>
                            <tr id="tableHeaderDashboard">
                                <th>შეკვეთა</th>
                                <th>მიმღები</th>
                                <th class="address-column-header">მისამართი</th> <th>კურიერი</th>
                                <th>ტემპი</th>
                                <th>სტატუსი</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyDashboard">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <h3>მონაცემები ჯერ არ არის ატვირთული</h3>
                                    <p>Excel ფაილის ატვირთვისთვის გამოიყენეთ ზედა ღილაკი</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- History View Container -->
        <div id="historyViewContainer" style="display: none;">
            <div class="filters card">
                <h3>ფილტრები</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterOrderHistory">შეკვეთა</label>
                        <input type="text" id="filterOrderHistory" placeholder="ძებნა შეკვეთის მიხედვით">
                    </div>
                    <div class="filter-group">
                        <label for="filterReceiverHistory">მიმღები</label>
                        <input type="text" id="filterReceiverHistory" placeholder="ძებნა მიმღების მიხედვით">
                    </div>
                    <div class="filter-group">
                        <label for="filterCourierHistory">კურიერი</label>
                        <select id="filterCourierHistory">
                            <option value="">ყველა კურიერი</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterStatusHistory">სტატუსი</label>
                        <select id="filterStatusHistory">
                            <option value="">ყველა სტატუსი</option>
                            <option value="ასაგროვებელი">ასაგროვებელი</option>
                            <option value="აგროვებული">აგროვებული</option>
                            <option value="პრობლემური">პრობლემური</option> <!-- NEW STATUS -->
                        </select>
                    </div>
                </div>
                <div class="address-toggle-group">
                    <input type="checkbox" id="toggleAddressColumnHistory" checked>
                    <label for="toggleAddressColumnHistory">მისამართის სვეტის ჩვენება</label>
                </div>
                <button class="button button-danger clear-filters" onclick="clearAllFiltersHistory()">
                    <i class="material-icons">filter_alt_off</i> ფილტრების გასუფთავება
                </button>
            </div>

            <div class="table-container">
                <div class="table-wrapper">
                    <table id="dataTableHistory">
                        <thead>
                            <tr id="tableHeaderHistory">
                                <th>შეკვეთა</th>
                                <th>მიმღები</th>
                                <th class="address-column-header">მისამართი</th> <th>კურიერი</th>
                                <th>ტემპი</th>
                                <th>სტატუსი</th>
                                <th>შეცვლის თარიღი</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyHistory">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <h3>მონაცემები ჯერ არ არის ატვირთული</h3>
                                    <p>Excel ფაილის ატვირთვისთვის გამოიყენეთ ზედა ღილაკი</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Data View Container -->
        <div id="dataViewContainer" style="display: none;">
            <div class="filters card">
                <h3>მონაცემების ფილტრები</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterOrderData">შეკვეთა</label>
                        <input type="text" id="filterOrderData" placeholder="ძებნა შეკვეთის მიხედვით">
                    </div>
                    <div class="filter-group">
                        <label for="filterReceiverData">მიმღები</label>
                        <input type="text" id="filterReceiverData" placeholder="ძებნა მიმღების მიხედვით">
                    </div>
                    <div class="filter-group">
                        <label for="filterCourierData">კურიერი</label>
                        <select id="filterCourierData">
                            <option value="">ყველა კურიერი</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterStatusData">სტატუსი</label>
                        <select id="filterStatusData">
                            <option value="">ყველა სტატუსი</option>
                            <option value="ასაგროვებელი">ასაგროვებელი</option>
                            <option value="აგროვებული">აგროვებული</option>
                            <option value="პრობლემური">პრობლემური</option> <!-- NEW STATUS -->
                        </select>
                    </div>
                </div>
                <!-- Date filter with checkboxes -->
                <div class="date-filter-checkbox-group">
                    <div>
                        <input type="checkbox" id="filterByUploadDateCheckbox" checked>
                        <label for="filterByUploadDateCheckbox">ფილტრი ატვირთვის დროით</label>
                    </div>
                    <div>
                        <input type="checkbox" id="filterByCollectionDateCheckbox">
                        <label for="filterByCollectionDateCheckbox">ფილტრი აგროვების დროით</label>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="date-filter-group">
                        <label for="filterStartDate">თარიღი - დაწყება</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div class="date-filter-group">
                        <label for="filterEndDate">თარიღი - დასრულება</label>
                        <input type="date" id="filterEndDate">
                    </div>
                </div>
                <!-- END Date filter with checkboxes -->
                <div class="address-toggle-group">
                    <input type="checkbox" id="toggleAddressColumnData" checked>
                    <label for="toggleAddressColumnData">მისამართის სვეტის ჩვენება</label>
                </div>
                <button class="button button-danger clear-filters" onclick="clearAllFiltersData()">
                    <i class="material-icons">filter_alt_off</i> ფილტრების გასუფთავება
                </button>
            </div>

            <div class="table-container">
                <div class="table-wrapper">
                    <table id="dataTableData">
                        <thead>
                            <tr id="tableHeaderData">
                                <th>შეკვეთა</th>
                                <th>შეკვეთის ატვირთვის დრო</th>
                                <th>აგროვების დრო</th>
                                <th>მიმღები</th>
                                <th class="address-column-header">მისამართი</th> <th>კურიერი</th>
                                <th>ტემპი</th>
                                <th>სტატუსი</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyData">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <h3>მონაცემები ჯერ არ არის ატვირთული</h3>
                                    <p>Excel ფაილის ატვირთვისთვის გამოიყენეთ ზედა ღილაკი</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Problematic View Container -->
        <div id="problematicViewContainer" style="display: none;">
            <div class="filters card">
                <h3>პრობლემური შეკვეთების ფილტრები</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterOrderProblematic">შეკვეთა</label>
                        <input type="text" id="filterOrderProblematic" placeholder="ძებნა შეკვეთის მიხედვით">
                    </div>
                    <div class="filter-group">
                        <label for="filterReceiverProblematic">მიმღები</label>
                        <input type="text" id="filterReceiverProblematic" placeholder="ძებნა მიმღების მიხედვით">
                    </div>
                    <div class="filter-group">
                        <label for="filterCourierProblematic">კურიერი</label>
                        <select id="filterCourierProblematic">
                            <option value="">ყველა კურიერი</option>
                        </select>
                    </div>
                </div>
                <div class="address-toggle-group">
                    <input type="checkbox" id="toggleAddressColumnProblematic" checked>
                    <label for="toggleAddressColumnProblematic">მისამართის სვეტის ჩვენება</label>
                </div>
                <button class="button button-danger clear-filters" onclick="clearAllFiltersProblematic()">
                    <i class="material-icons">filter_alt_off</i> ფილტრების გასუფთავება
                </button>
            </div>

            <div class="table-container">
                <div class="table-wrapper">
                    <table id="dataTableProblematic">
                        <thead>
                            <tr id="tableHeaderProblematic">
                                <th>შეკვეთა</th>
                                <th>მიმღები</th>
                                <th class="address-column-header">მისამართი</th> <th>კურიერი</th>
                                <th>ტემპი</th>
                                <th>სტატუსი</th>
                                <th>შემოსვლის თარიღი</th>
                                <th>კომენტარი</th> <!-- NEW COLUMN -->
                            </tr>
                        </thead>
                        <tbody id="tableBodyProblematic">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <h3>მონაცემები ჯერ არ არის ატვირთული</h3>
                                    <p>Excel ფაილის ატვირთვისთვის გამოიყენეთ ზედა ღილაკი</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div id="notification" class="notification"></div>

    <!-- Custom Comment Modal -->
    <div id="commentModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <span class="material-icons modal-close-btn" onclick="hideCommentModal()">close</span>
            <h3 id="commentModalTitle">კომენტარი</h3>
            <p id="commentModalText"></p>
            <span id="commentModalTimestamp" class="comment-timestamp"></span>
        </div>
    </div>
    <!-- END Custom Comment Modal -->

    <script>
        // Helper function to update sync indicator
        function updateSyncIndicator(status, message) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatus');
            
            indicator.className = `sync-indicator ${status}`;
            statusText.textContent = message;
        }

        // Helper function to show notifications
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => {
                notification.className = `notification ${type}`;
            }, 3000);
        }

        // *** Firebase Configuration - ეს თქვენი Firebase პროექტის მონაცემებია ***
        const firebaseConfig = {
            apiKey: "AIzaSyAX83Mj3ZPlhTC1PGlwpP6nNPc9INj_iAE",
            authDomain: "picking-2da5d.firebaseapp.com",
            databaseURL: "https://picking-2da5d-default-rtdb.firebaseio.com",
            projectId: "picking-2da5d",
            storageBucket: "picking-2da5d.firebasestorage.app",
            messagingSenderId: "985054920430",
            appId: "1:985054920430:web:2e49cd2b1ebbab9ba23dff",
            measurementId: "G-ZEJHW847HT"
        };
        // *** დასრულდა Firebase კონფიგურაციის ადგილი ***

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const ordersRef = database.ref('orders'); 

        let data = []; 
        let filteredData = [];
        let currentView = 'dashboard';

        // Variables to store filter values for each view
        let filterValues = {
            dashboard: { order: '', receiver: '', courier: '', status: '' },
            history: { order: '', receiver: '', courier: '', status: '' },
            data: { order: '', receiver: '', courier: '', status: '', startDate: '', endDate: '', filterByUploadDate: true, filterByCollectionDate: false },
            problematic: { order: '', receiver: '', courier: '' }
        };

        let showAddressColumnDashboard = true;
        let showAddressColumnHistory = true;
        let showAddressColumnData = true;
        let showAddressColumnProblematic = true;
        
        // --- Dark Mode Logic ---
        const darkModeToggleBtn = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');
        const darkModeText = document.getElementById('darkModeText'); 

        function setDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                darkModeIcon.textContent = 'light_mode'; 
                if (darkModeText) darkModeText.textContent = 'ნათელი რეჟიმი'; 
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                darkModeIcon.textContent = 'dark_mode'; 
                if (darkModeText) darkModeText.textContent = 'ბნელი რეჟიმი'; 
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleDarkMode() {
            const isCurrentlyDark = document.body.classList.contains('dark-mode');
            setDarkMode(!isCurrentlyDark);
        }

        // --- Address Column Toggle Logic (Updated for multiple views) ---
        const toggleAddressCheckboxDashboard = document.getElementById('toggleAddressColumn');
        const toggleAddressCheckboxHistory = document.getElementById('toggleAddressColumnHistory');
        const toggleAddressCheckboxData = document.getElementById('toggleAddressColumnData');
        const toggleAddressCheckboxProblematic = document.getElementById('toggleAddressColumnProblematic');

        const dashboardViewContainer = document.getElementById('dashboardViewContainer');
        const historyViewContainer = document.getElementById('historyViewContainer');
        const dataViewContainer = document.getElementById('dataViewContainer');
        const problematicViewContainer = document.getElementById('problematicViewContainer');


        function updateAddressColumnVisibility() {
            showAddressColumnDashboard = toggleAddressCheckboxDashboard.checked;
            showAddressColumnHistory = toggleAddressCheckboxHistory.checked;
            showAddressColumnData = toggleAddressCheckboxData.checked;
            showAddressColumnProblematic = toggleAddressCheckboxProblematic.checked;

            renderTable(); 

            localStorage.setItem('showAddressColumnDashboard', showAddressColumnDashboard);
            localStorage.setItem('showAddressColumnHistory', showAddressColumnHistory);
            localStorage.setItem('showAddressColumnData', showAddressColumnData);
            localStorage.setItem('showAddressColumnProblematic', showAddressColumnProblematic);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                setDarkMode(true);
            } else {
                setDarkMode(false); 
            }

            // Load saved visibility settings
            showAddressColumnDashboard = (localStorage.getItem('showAddressColumnDashboard') !== 'false');
            showAddressColumnHistory = (localStorage.getItem('showAddressColumnHistory') !== 'false');
            showAddressColumnData = (localStorage.getItem('showAddressColumnData') !== 'false');
            showAddressColumnProblematic = (localStorage.getItem('showAddressColumnProblematic') !== 'false');

            toggleAddressCheckboxDashboard.checked = showAddressColumnDashboard;
            toggleAddressCheckboxHistory.checked = showAddressColumnHistory;
            toggleAddressCheckboxData.checked = showAddressColumnData;
            toggleAddressCheckboxProblematic.checked = showAddressColumnProblematic;
            
            // Load saved filter values
            try {
                const savedFilters = localStorage.getItem('filterValues');
                if (savedFilters) {
                    filterValues = JSON.parse(savedFilters);
                }
            } catch (e) {
                console.error("Error loading saved filters:", e);
            }

            // Initialize filter inputs with loaded values
            document.getElementById('filterOrder').value = filterValues.dashboard.order;
            document.getElementById('filterReceiver').value = filterValues.dashboard.receiver;
            document.getElementById('filterCourier').value = filterValues.dashboard.courier;
            document.getElementById('filterStatus').value = filterValues.dashboard.status;

            document.getElementById('filterOrderHistory').value = filterValues.history.order;
            document.getElementById('filterReceiverHistory').value = filterValues.history.receiver;
            document.getElementById('filterCourierHistory').value = filterValues.history.courier;
            document.getElementById('filterStatusHistory').value = filterValues.history.status;

            document.getElementById('filterOrderData').value = filterValues.data.order;
            document.getElementById('filterReceiverData').value = filterValues.data.receiver;
            document.getElementById('filterCourierData').value = filterValues.data.courier;
            document.getElementById('filterStatusData').value = filterValues.data.status;
            document.getElementById('filterStartDate').value = filterValues.data.startDate;
            document.getElementById('filterEndDate').value = filterValues.data.endDate;
            document.getElementById('filterByUploadDateCheckbox').checked = filterValues.data.filterByUploadDate;
            document.getElementById('filterByCollectionDateCheckbox').checked = filterValues.data.filterByCollectionDate;

            document.getElementById('filterOrderProblematic').value = filterValues.problematic.order;
            document.getElementById('filterReceiverProblematic').value = filterValues.problematic.receiver;
            document.getElementById('filterCourierProblematic').value = filterValues.problematic.courier;

            updateAddressColumnVisibility(); // Call after loading filter values
        });
        toggleAddressCheckboxDashboard.addEventListener('change', updateAddressColumnVisibility);
        toggleAddressCheckboxHistory.addEventListener('change', updateAddressColumnVisibility);
        toggleAddressCheckboxData.addEventListener('change', updateAddressColumnVisibility);
        toggleAddressCheckboxProblematic.addEventListener('change', updateAddressColumnVisibility);
        // --- End Address Column Toggle Logic ---


        window.addEventListener('load', function() {
            loadFirebaseData(); 
        });

        // Function to load data from Firebase
        function loadFirebaseData() {
            updateSyncIndicator('syncing', 'მონაცემების ჩატვირთვა Firebase-დან...');
            ordersRef.on('value', (snapshot) => {
                try {
                    const firebaseData = snapshot.val();
                    data = [];
                    if (firebaseData) {
                        // Firebase Realtime Database returns objects, convert to array of objects
                        for (let key in firebaseData) {
                            if (firebaseData.hasOwnProperty(key)) {
                                const item = firebaseData[key];
                                // Ensure each item has an 'id' matching its Firebase key
                                item.id = key; 
                                // Ensure comment objects have a timestamp, add if missing for old data
                                if (item.comment && typeof item.comment === 'string') {
                                    item.comment = { text: item.comment, timestamp: Date.now() }; 
                                } else if (item.comment && item.comment.text && !item.comment.timestamp) {
                                    item.comment.timestamp = Date.now();
                                } else if (!item.comment) {
                                    item.comment = null;
                                }
                                data.push(item);
                            }
                        }
                    }
                    populateCourierFilter();
                    applyFilters();
                    updateStats();
                    updateSyncIndicator('', 'სინქრონიზებული Firebase-თან');
                } catch (e) {
                    console.error("Error loading Firebase data:", e);
                    showNotification('შეცდომა Firebase მონაცემების ჩატვირთვისას.', 'error');
                    updateSyncIndicator('error', 'Firebase შეცდომა');
                }
            }, (error) => {
                console.error("Firebase Read Failed:", error);
                showNotification('Firebase-დან მონაცემების წაკითხვა ვერ მოხერხდა.', 'error');
                updateSyncIndicator('error', 'Firebase შეცდომა');
            });
        }

        // Function to save data to Firebase
        function saveFirebaseData() {
            // This function is implicitly called by individual updates or bulk operations.
            // The on('value') listener will handle updating the local 'data' array.
            // No need for a separate 'saveFirebaseData' function that sets the whole array
            // every time a small change happens, as it's inefficient.
            // Individual updates below handle saving to Firebase.
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    processAndUploadData(jsonData);
                    
                    showNotification('ფაილი წარმატებით ატვირთულია! მონაცემები განახლდება Firebase-ზე.');
                } catch (error) {
                    console.error('Error processing file:', error);
                    showNotification('შეცდომა ფაილის დამუშავებისას', 'error');
                }
            };
            reader.readAsBinaryString(file);
        });

        // Function to update existing data or add new data to Firebase
        function processAndUploadData(jsonData) {
            updateSyncIndicator('syncing', 'მონაცემების დამუშავება...');
            const updates = {}; // Object to hold all updates for Firebase
            const existingOrdersMap = new Map(data.map(item => [item.order, item])); // Use current 'data' state

            jsonData.forEach((row) => {
                const orderIdFromExcel = String(row['შეკვეთა'] || row['Order'] || '').trim();
                
                if (orderIdFromExcel) {
                    const existingItem = existingOrdersMap.get(orderIdFromExcel);
                    const now = Date.now();
                    
                    let itemToUpdate = {};
                    let firebaseKey = '';

                    if (existingItem) {
                        // Update existing item values, but preserve existing status and comment
                        itemToUpdate = { ...existingItem }; // Create a copy
                        firebaseKey = existingItem.id;

                        itemToUpdate.receiver = String(row['მიმღები'] || row['Receiver'] || '').trim();
                        itemToUpdate.address = String(row['მისამართი'] || row['Address'] || '').trim();
                        itemToUpdate.courier = String(row['კურიერი'] || row['Courier'] || '').trim();
                        itemToUpdate.type = String(row['ტემპი'] || row['Type'] || '').trim();
                        
                        // Only set uploadDate if it's missing (for older data structure or new data)
                        if (itemToUpdate.uploadDate === undefined || itemToUpdate.uploadDate === null) {
                            itemToUpdate.uploadDate = now;
                        }

                    } else {
                        // Add new item
                        firebaseKey = ordersRef.push().key; // Get a unique Firebase push key
                        itemToUpdate = {
                            order: orderIdFromExcel,
                            receiver: String(row['მიმღები'] || row['Receiver'] || '').trim(),
                            address: String(row['მისამართი'] || row['Address'] || '').trim(), 
                            courier: String(row['კურიერი'] || row['Courier'] || '').trim(),
                            type: String(row['ტემპი'] || row['Type'] || '').trim(),
                            status: 'ასაგროვებელი', // Default status for new orders
                            statusChangedDate: null,
                            uploadDate: now, // Set upload date for new orders
                            comment: null // New orders start without a comment
                        };
                    }
                    updates[firebaseKey] = itemToUpdate; // Add to batch update object
                }
            });

            ordersRef.update(updates)
                .then(() => {
                    // Data updated in Firebase, listener will handle local 'data' array update
                    updateSyncIndicator('', 'Firebase-ის მონაცემები განახლდა');
                    showNotification('მონაცემები წარმატებით განახლდა/დაემატა Firebase-ში.');
                })
                .catch(error => {
                    console.error("Firebase Update Failed:", error);
                    updateSyncIndicator('error', 'Firebase განახლების შეცდომა');
                    showNotification('Firebase-ზე მონაცემების განახლება ვერ მოხერხდა.', 'error');
                });
        }

        // Populates courier filter for all views
        function populateCourierFilter() {
            const couriers = [...new Set(data.map(item => item.courier))].filter(Boolean).sort();
            const courierSelects = ['filterCourier', 'filterCourierHistory', 'filterCourierData', 'filterCourierProblematic'];
            
            courierSelects.forEach(selectId => {
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    const currentViewKey = selectId.replace('filterCourier', '').toLowerCase() || 'dashboard';
                    // Save current selection before clearing options
                    const currentSelection = selectElement.value;
                    selectElement.innerHTML = '<option value="">ყველა კურიერი</option>';
                    couriers.forEach(courier => {
                        const option = document.createElement('option');
                        option.value = courier;
                        option.textContent = courier;
                        selectElement.appendChild(option);
                    });
                    // Restore previous selection if it's still a valid option
                    if (couriers.includes(currentSelection)) {
                        selectElement.value = currentSelection;
                    } else {
                        selectElement.value = ''; // Reset if invalid
                    }
                }
            });
        }

        // Helper function to format timestamp to 'DD.MM.YYYY HH:MM'
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(Number(timestamp)); 
            const pad = (num) => num < 10 ? '0' + num : num;
            return `${pad(date.getDate())}.${pad(date.getMonth() + 1)}.${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        // Helper function to convert 'date' string to timestamp (start of day)
        function dateToStartOfDayTimestamp(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            date.setHours(0, 0, 0, 0); 
            return date.getTime();
        }

        // Helper function to convert 'date' string to timestamp (end of day)
        function dateToEndOfDayTimestamp(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            date.setHours(23, 59, 59, 999); 
            return date.getTime();
        }

        // Show Comment Modal - Now displays comment text and timestamp
        function showCommentModal(commentText, commentTimestamp) {
            const modalOverlay = document.getElementById('commentModalOverlay');
            const modalText = document.getElementById('commentModalText');
            const modalTimestamp = document.getElementById('commentModalTimestamp');

            modalText.textContent = commentText || 'კომენტარი არ არის';
            if (commentTimestamp && commentTimestamp !== 'undefined') { 
                modalTimestamp.textContent = `(${formatTimestamp(commentTimestamp)})`;
            } else {
                modalTimestamp.textContent = '';
            }
            modalOverlay.classList.add('show');
        }

        // Hide Comment Modal
        function hideCommentModal() {
            const modalOverlay = document.getElementById('commentModalOverlay');
            modalOverlay.classList.remove('show');
        }


        function renderTable() {
            let tbodyId, headerId, colspan, addressColumnVisible;
            let tableData = filteredData; 

            switch (currentView) {
                case 'dashboard':
                    tbodyId = 'tableBodyDashboard';
                    headerId = 'tableHeaderDashboard';
                    colspan = 6;
                    addressColumnVisible = showAddressColumnDashboard;
                    break;
                case 'history':
                    tbodyId = 'tableBodyHistory';
                    headerId = 'tableHeaderHistory';
                    colspan = 7;
                    addressColumnVisible = showAddressColumnHistory;
                    break;
                case 'data':
                    tbodyId = 'tableBodyData';
                    headerId = 'tableHeaderData';
                    colspan = 8;
                    addressColumnVisible = showAddressColumnData;
                    break;
                case 'problematic':
                    tbodyId = 'tableBodyProblematic';
                    headerId = 'tableHeaderProblematic';
                    colspan = 8; 
                    addressColumnVisible = showAddressColumnProblematic;
                    break;
            }

            const tbody = document.getElementById(tbodyId);
            const header = document.getElementById(headerId);
            
            let headersHtml = '';
            if (currentView === 'dashboard' || currentView === 'history' || currentView === 'problematic') {
                headersHtml = `
                    <th>შეკვეთა</th>
                    <th>მიმღები</th>
                    <th class="${addressColumnVisible ? '' : 'address-column-header'}">მისამართი</th> 
                    <th>კურიერი</th>
                    <th>ტემპი</th>
                    <th>სტატუსი</th>
                `;
                if (currentView === 'history') {
                    headersHtml += `<th>შეცვლის თარიღი</th>`;
                } else if (currentView === 'problematic') {
                    headersHtml += `<th>შემოსვლის თარიღი</th><th>კომენტარი</th>`;
                }
            } else if (currentView === 'data') {
                headersHtml = `
                    <th>შეკვეთა</th>
                    <th>შეკვეთის ატვირთვის დრო</th>
                    <th>აგროვების დრო</th>
                    <th>მიმღები</th>
                    <th class="${addressColumnVisible ? '' : 'address-column-header'}">მისამართი</th> 
                    <th>კურიერი</th>
                    <th>ტემპი</th>
                    <th>სტატუსი</th>
                `;
            }

            header.innerHTML = headersHtml;

            if (tableData.length === 0) {
                const message = data.length === 0 ?
                    '<h3>მონაცემები ჯერ არ არის ატვირთული</h3><p>Excel ფაილის ატვირთვისთვის გამოიყენეთ ზედა ღილაკი</p>' :
                    '<h3>მონაცემები არ მოიძებნა</h3><p>სცადეთ ფილტრების შეცვლა</p>';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${colspan}" class="empty-state">
                            ${message}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = tableData.map(item => {
                let statusClass;
                switch(item.status) {
                    case 'აგროვებული':
                        statusClass = 'status-collected';
                        break;
                    case 'ასაგროვებელი':
                        statusClass = 'status-collect';
                        break;
                    case 'პრობლემური':
                        statusClass = 'status-problematic';
                        break;
                    default:
                        statusClass = '';
                }
                
                let statusCellContent;
                const optionsHtml = `
                    <option value="ასაგროვებელი" ${item.status === 'ასაგროვებელი' ? 'selected' : ''}>ასაგროვებელი</option>
                    <option value="აგროვებული" ${item.status === 'აგროვებული' ? 'selected' : ''}>აგროვებული</option>
                    <option value="პრობლემური" ${item.status === 'პრობლემური' ? 'selected' : ''}>პრობლემური</option>
                `;

                if (currentView === 'dashboard' && item.status === 'ასაგროვებელი') {
                    statusCellContent = `
                        <select onchange="handleStatusChangeDropdown(this, '${item.id}', '${item.status}')" class="status-dropdown ${statusClass}">
                            <option value="ასაგროვებელი" ${item.status === 'ასაგროვებელი' ? 'selected' : ''}>ასაგროვებელი</option>
                            <option value="აგროვებული" ${item.status === 'აგროვებული' ? 'selected' : ''}>აგროვებული</option>
                            <option value="პრობლემური" ${item.status === 'პრობლემური' ? 'selected' : ''}>პრობლემური</option>
                        </select>
                    `;
                } else if (currentView === 'problematic' || currentView === 'history') {
                    statusCellContent = `
                        <select onchange="handleStatusChangeDropdown(this, '${item.id}', '${item.status}')" class="status-dropdown ${statusClass}">
                            ${optionsHtml}
                        </select>
                    `;
                } else {
                    // Default for data view, or if not eligible for dropdown
                    statusCellContent = `<span class="status-badge ${statusClass}">${item.status}</span>`;
                }


                const addressCellClass = addressColumnVisible ? '' : 'address-column-data';
                const addressCellContent = `<td class="${addressCellClass}">${item.address || ''}</td>`;

                let rowHtml = ``;

                const commentTextForModal = item.comment && item.comment.text ? item.comment.text.replace(/'/g, "\\'") : '';
                const commentTimestampForModal = item.comment && item.comment.timestamp ? item.comment.timestamp : '';
                const commentIcon = (item.comment && item.comment.text) 
                    ? `<span class="material-icons comment-icon" onclick="showCommentModal('${commentTextForModal}', '${commentTimestampForModal}')">chat_bubble_outline</span>` : '';
                
                let commentColumnContent = '';
                if (currentView === 'problematic') {
                    commentColumnContent = `<td>${item.comment && item.comment.text ? `<span class="material-icons comment-icon" onclick="showCommentModal('${commentTextForModal}', '${commentTimestampForModal}')">chat_bubble_outline</span>` : '-'}</td>`;
                }


                if (currentView === 'dashboard' || currentView === 'history' || currentView === 'problematic') {
                    const extraDateColumn = (currentView === 'history' && item.statusChangedDate) 
                        ? `<td class="date-column">${formatTimestamp(item.statusChangedDate)}</td>` 
                        : (currentView === 'problematic' && item.uploadDate)
                        ? `<td class="date-column">${formatTimestamp(item.uploadDate)}</td>`
                        : (currentView === 'history' || currentView === 'problematic') ? '<td class="date-column">-</td>' : '';
                    
                    rowHtml = `
                        <tr>
                            <td>${item.order}</td>
                            <td>${item.receiver}</td>
                            ${addressCellContent} 
                            <td>${item.courier}</td>
                            <td>${item.type}</td>
                            <td>${statusCellContent} ${commentIcon}</td>
                            ${extraDateColumn}
                            ${commentColumnContent}
                        </tr>
                    `;
                } else if (currentView === 'data') {
                    rowHtml = `
                        <tr>
                            <td>${item.order}</td>
                            <td class="date-column">${formatTimestamp(item.uploadDate)}</td>
                            <td class="date-column">${formatTimestamp(item.statusChangedDate)}</td>
                            <td>${item.receiver}</td>
                            ${addressCellContent}
                            <td>${item.courier}</td>
                            <td>${item.type}</td>
                            <td>${statusCellContent} ${commentIcon}</td>
                        </tr>
                    `;
                }
                return rowHtml;
            }).join('');
        }

        // Handles status changes via dropdown and updates Firebase
        function handleStatusChangeDropdown(selectElement, id, oldStatus) {
            const newStatus = selectElement.value;

            if (newStatus === oldStatus) {
                return; // No change, do nothing
            }

            let confirmationNeeded = true;
            let commentText = null;

            if (currentView === 'dashboard' && oldStatus === 'ასაგროვებელი') {
                confirmationNeeded = false; // No popup on dashboard for any status change
                if (newStatus === 'პრობლემური') {
                    commentText = prompt('გთხოვთ, შეიყვანოთ კომენტარი პრობლემური შეკვეთისთვის:');
                    if (commentText === null) { 
                        selectElement.value = oldStatus; 
                        return; 
                    }
                }
            } else if (newStatus === 'პრობლემური') { 
                commentText = prompt('გთხოვთ, შეიყვანოთ კომენტარი პრობლემური შეკვეთისთვის:');
                if (commentText === null) { 
                    selectElement.value = oldStatus; 
                    return; 
                }
                confirmationNeeded = true; 
            } else { // For any other status change (e.g., from problematic to collected/to_collect)
                confirmationNeeded = true;
            }


            if (confirmationNeeded && !confirm(`ნამდვილად გსურთ სტატუსის "${oldStatus}"-დან "${newStatus}"-ზე შეცვლა?`)) {
                selectElement.value = oldStatus; 
                return; 
            }

            const itemIndex = data.findIndex(item => item.id === id);
            if (itemIndex > -1) {
                updateSyncIndicator('syncing', 'Firebase-ის განახლება...');
                const item = { ...data[itemIndex] }; // Create a copy to modify

                item.status = newStatus;
                const now = Date.now();

                if (newStatus === 'აგროვებული') {
                    item.statusChangedDate = now;
                } else {
                    item.statusChangedDate = null; 
                }

                if (newStatus === 'პრობლემური' && commentText !== null) {
                    item.comment = { text: commentText, timestamp: now }; 
                } else if (oldStatus === 'პრობლემური' && newStatus !== 'პრობლემური') {
                    item.comment = null; 
                }

                // Update the item in Firebase
                ordersRef.child(id).update(item)
                    .then(() => {
                        // Firebase listener will automatically update local 'data' array
                        // and trigger applyFilters/updateStats
                        updateSyncIndicator('', 'Firebase-ის მონაცემები განახლდა');
                        showNotification('სტატუსი განახლდა Firebase-ში.');
                    })
                    .catch(error => {
                        console.error("Firebase Update Failed:", error);
                        updateSyncIndicator('error', 'Firebase განახლების შეცდომა');
                        showNotification('სტატუსის განახლება ვერ მოხერხდა Firebase-ში.', 'error');
                    });
            } else {
                showNotification('მონაცემები ვერ მოიძებნა.', 'error');
            }
        }


        // Function to hide all view containers and then show the selected one
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.view-toggle .view-btn[onclick="switchView('${view}')"]`).classList.add('active');

            dashboardViewContainer.style.display = 'none';
            historyViewContainer.style.display = 'none';
            dataViewContainer.style.display = 'none';
            problematicViewContainer.style.display = 'none';

            switch(view) {
                case 'dashboard':
                    dashboardViewContainer.style.display = 'block';
                    break;
                case 'history':
                    historyViewContainer.style.display = 'block';
                    break;
                case 'data':
                    dataViewContainer.style.display = 'block';
                    break;
                case 'problematic':
                    problematicViewContainer.style.display = 'block';
                    break;
            }
            applyFilters();
        }

        function updateStats() {
            const total = data.length;
            const toCollect = data.filter(item => item.status === 'ასაგროვებელი').length;
            const collected = data.filter(item => item.status === 'აგროვებული').length;

            document.getElementById('totalOrders').textContent = total;
            document.getElementById('toCollectOrders').textContent = toCollect;
            document.getElementById('collectedOrders').textContent = collected;

            // Calculate Average Collection Speed (24-hour window)
            let totalCollectionTime = 0; 
            let collectedCount24h = 0;

            data.forEach(item => {
                if (item.status === 'აგროვებული' && item.uploadDate && item.statusChangedDate) {
                    const timeDiff = item.statusChangedDate - item.uploadDate; 
                    const twentyFourHours = 24 * 60 * 60 * 1000;

                    if (timeDiff >= 0 && timeDiff <= twentyFourHours) {
                        totalCollectionTime += timeDiff;
                        collectedCount24h++;
                    }
                }
            });

            let avgSpeedText = 'N/A';
            if (collectedCount24h > 0) {
                const avgMilliseconds = totalCollectionTime / collectedCount24h;
                const avgHours = Math.floor(avgMilliseconds / (1000 * 60 * 60));
                const avgMinutes = Math.floor((avgMilliseconds % (1000 * 60 * 60)) / (1000 * 60));
                avgSpeedText = `${avgHours}სთ ${avgMinutes}წთ`;
            }
            document.getElementById('avgCollectionSpeed').textContent = avgSpeedText;
        }

        // Unified applyFilters function for all views
        function applyFilters() {
            // Update filterValues object from current input states
            filterValues.dashboard.order = document.getElementById('filterOrder').value.toLowerCase().trim();
            filterValues.dashboard.receiver = document.getElementById('filterReceiver').value.toLowerCase().trim();
            filterValues.dashboard.courier = document.getElementById('filterCourier').value;
            filterValues.dashboard.status = document.getElementById('filterStatus').value;

            filterValues.history.order = document.getElementById('filterOrderHistory').value.toLowerCase().trim();
            filterValues.history.receiver = document.getElementById('filterReceiverHistory').value.toLowerCase().trim();
            filterValues.history.courier = document.getElementById('filterCourierHistory').value;
            filterValues.history.status = document.getElementById('filterStatusHistory').value;

            filterValues.data.order = document.getElementById('filterOrderData').value.toLowerCase().trim();
            filterValues.data.receiver = document.getElementById('filterReceiverData').value.toLowerCase().trim();
            filterValues.data.courier = document.getElementById('filterCourierData').value;
            filterValues.data.status = document.getElementById('filterStatusData').value;
            filterValues.data.startDate = document.getElementById('filterStartDate').value;
            filterValues.data.endDate = document.getElementById('filterEndDate').value;
            filterValues.data.filterByUploadDate = document.getElementById('filterByUploadDateCheckbox').checked;
            filterValues.data.filterByCollectionDate = document.getElementById('filterByCollectionDateCheckbox').checked;

            filterValues.problematic.order = document.getElementById('filterOrderProblematic').value.toLowerCase().trim();
            filterValues.problematic.receiver = document.getElementById('filterReceiverProblematic').value.toLowerCase().trim();
            filterValues.problematic.courier = document.getElementById('filterCourierProblematic').value;

            // Save current filters to localStorage (only filters, not actual data)
            try {
                localStorage.setItem('filterValues', JSON.stringify(filterValues)); 
            } catch (e) {
                console.error("Error saving filter values to local storage:", e);
                showNotification('შეცდომა ფილტრების შენახვისას ლოკალურად.', 'error');
            }

            let currentFilter = filterValues[currentView];
            let dataToFilter = [...data];
            
            // Initial view-specific filtering
            if (currentView === 'dashboard') {
                dataToFilter = dataToFilter.filter(item => item.status === 'ასაგროვებელი');
            } else if (currentView === 'history') {
                dataToFilter = dataToFilter.filter(item => item.status === 'აგროვებული'); 
            } else if (currentView === 'problematic') {
                const now = Date.now();
                const twentyFourHours = 24 * 60 * 60 * 1000;
                dataToFilter = dataToFilter.filter(item => {
                    return item.status === 'პრობლემური' || 
                           (item.status === 'ასაგროვებელი' && item.uploadDate && (now - item.uploadDate) > twentyFourHours);
                });
            }

            // Apply common filters
            filteredData = dataToFilter.filter(item => {
                const orderMatch = !currentFilter.order || String(item.order).toLowerCase().includes(currentFilter.order);
                const receiverMatch = !currentFilter.receiver || String(item.receiver).toLowerCase().includes(currentFilter.receiver);
                const courierMatch = !currentFilter.courier || item.courier === currentFilter.courier;
                const statusMatch = (currentView === 'data' || currentView === 'history' || currentView === 'dashboard') ? (!currentFilter.status || item.status === currentFilter.status) : true;
                
                let dateRangeMatch = true;

                if (currentView === 'data' && (currentFilter.startDate || currentFilter.endDate)) {
                    let itemDate = null;
                    if (currentFilter.filterByUploadDate && item.uploadDate) {
                        itemDate = item.uploadDate;
                    } else if (currentFilter.filterByCollectionDate && item.statusChangedDate) {
                        itemDate = item.statusChangedDate;
                    }

                    if (itemDate) {
                        const filterStartDateTs = dateToStartOfDayTimestamp(currentFilter.startDate);
                        const filterEndDateTs = dateToEndOfDayTimestamp(currentFilter.endDate);

                        if (filterStartDateTs) {
                            dateRangeMatch = dateRangeMatch && itemDate >= filterStartDateTs;
                        }
                        if (filterEndDateTs) {
                            dateRangeMatch = dateRangeMatch && itemDate <= filterEndDateTs;
                        }
                    } else {
                        dateRangeMatch = false; 
                    }
                }
                
                return orderMatch && receiverMatch && courierMatch && statusMatch && dateRangeMatch;
            });
            renderTable();
        }

        // Event listeners for filters
        document.getElementById('filterOrder').addEventListener('input', applyFilters);
        document.getElementById('filterReceiver').addEventListener('input', applyFilters);
        document.getElementById('filterCourier').addEventListener('change', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);

        document.getElementById('filterOrderHistory').addEventListener('input', applyFilters);
        document.getElementById('filterReceiverHistory').addEventListener('input', applyFilters);
        document.getElementById('filterCourierHistory').addEventListener('change', applyFilters);
        document.getElementById('filterStatusHistory').addEventListener('change', applyFilters);

        document.getElementById('filterOrderData').addEventListener('input', applyFilters);
        document.getElementById('filterReceiverData').addEventListener('input', applyFilters);
        document.getElementById('filterCourierData').addEventListener('change', applyFilters);
        document.getElementById('filterStatusData').addEventListener('change', applyFilters);
        
        document.getElementById('filterStartDate').addEventListener('change', applyFilters);
        document.getElementById('filterEndDate').addEventListener('change', applyFilters);
        document.getElementById('filterByUploadDateCheckbox').addEventListener('change', applyFilters);
        document.getElementById('filterByCollectionDateCheckbox').addEventListener('change', applyFilters);


        document.getElementById('filterOrderProblematic').addEventListener('input', applyFilters);
        document.getElementById('filterReceiverProblematic').addEventListener('input', applyFilters);
        document.getElementById('filterCourierProblematic').addEventListener('change', applyFilters);


        // Clear filter functions for each view
        function clearAllFilters() { 
            document.getElementById('filterOrder').value = '';
            document.getElementById('filterReceiver').value = '';
            document.getElementById('filterCourier').value = '';
            document.getElementById('filterStatus').value = '';
            applyFilters();
        }
        function clearAllFiltersHistory() { 
            document.getElementById('filterOrderHistory').value = '';
            document.getElementById('filterReceiverHistory').value = '';
            document.getElementById('filterCourierHistory').value = '';
            document.getElementById('filterStatusHistory').value = '';
            applyFilters();
        }
        function clearAllFiltersData() { 
            document.getElementById('filterOrderData').value = '';
            document.getElementById('filterReceiverData').value = '';
            document.getElementById('filterCourierData').value = '';
            document.getElementById('filterStatusData').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterByUploadDateCheckbox').checked = true; 
            document.getElementById('filterByCollectionDateCheckbox').checked = false; 
            applyFilters();
        }
        function clearAllFiltersProblematic() { 
            document.getElementById('filterOrderProblematic').value = '';
            document.getElementById('filterReceiverProblematic').value = '';
            document.getElementById('filterCourierProblematic').value = '';
            applyFilters();
        }


        const ADMIN_CODE = "321321";
        function promptForClearData() {
            const enteredCode = prompt('გთხოვთ, შეიყვანოთ ადმინისტრატორის კოდი მონაცემების წასაშლელად:');
            if (enteredCode === ADMIN_CODE) {
                clearAllData();
            } else if (enteredCode !== null) { 
                showNotification('არასწორი კოდი. მონაცემები არ წაიშალა.', 'error');
            }
        }

        // Clears all data from Firebase
        function clearAllData() {
            if (confirm('ნამდვილად გსურთ ყველა მონაცემის წაშლა? ეს ქმედება შეუქცევადია. ეს წაშლის მონაცემებს Firebase-დან!')) {
                updateSyncIndicator('syncing', 'მონაცემების წაშლა...');
                ordersRef.remove()
                    .then(() => {
                        // Firebase listener will clear local 'data' and update UI
                        localStorage.removeItem('filterValues'); // Clear filter values too
                        document.getElementById('fileName').textContent = '';
                        populateCourierFilter(); // Re-populate with empty data
                        applyFilters(); // Re-apply filters with empty data
                        updateStats(); // Update stats to 0
                        updateSyncIndicator('', 'Firebase-ის მონაცემები წაშლილია!');
                        showNotification('ყველა მონაცემი წაშლილია Firebase-დან.');
                    })
                    .catch(error => {
                        console.error("Firebase Delete Failed:", error);
                        updateSyncIndicator('error', 'მონაცემების წაშლის შეცდომა');
                        showNotification('მონაცემების წაშლა ვერ მოხერხდა Firebase-დან.', 'error');
                    });
            }
        }
    </script>
</body>
</html>
