<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>შეკვეთების მართვის სისტემა</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* აქ მომხმარებლის მიერ წარსული სტილი დარჩენა */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #334155; }
        .container { max-width: 1400px; margin:0 auto; padding:20px; }
        .header { background:white; padding:20px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; }
        .logo { cursor:pointer; display:flex; align-items:center; }
        .logo img { height:40px; margin-right:10px; }
        .upload-section { display:flex; gap:15px; align-items:center; flex-wrap:wrap; }
        .file-input-wrapper { position:relative; overflow:hidden; display:inline-block; }
        .file-input { display:none; }
        .file-input-label { background:#3b82f6; color:white; padding:10px 20px; border-radius:8px; cursor:pointer; transition:0.2s; font-weight:500; }
        .file-input-label:hover { background:#2563eb; }
        .view-toggle { display:flex; gap:10px; margin-bottom:20px; }
        .view-btn { background:white; border:2px solid #e5e7eb; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:500; transition:0.2s; }
        .view-btn.active { background:#3b82f6; color:white; border-color:#3b82f6; }
        .view-btn:hover:not(.active) { border-color:#3b82f6; color:#3b82f6; }
        .filters, .table-container, .stat-card { ... /* სხვა სტილი უცვლელია */ }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo" onclick="location.reload()">
                <img src="https://your-cdn.com/dressup-logo.png" alt="Dressup Logo">
                <h1>Dressup შეკვეთების სისტემა</h1>
            </div>
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
                    <label for="fileInput" class="file-input-label">Excel ფაილის ატვირთვა</label>
                </div>
                <span id="fileName" style="color:#6b7280;"></span>
            </div>
        </div>

        <!-- view-ს, stats, filters, table ნაწილი უცვლელია -->

    </div>

    <script>
        let data = [];
        let filteredData = [];
        let currentView = 'dashboard';

        const STORAGE_KEY = 'dressup_orders';

        // Page init
        window.addEventListener('DOMContentLoaded', () => {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                data = JSON.parse(stored);
                populateCourierFilter();
                applyFilters();
                updateStats();
                document.getElementById('fileName').textContent = '— ადგილობრივი მონაცემები —';
            }
        });

        // Upload input
        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileName').textContent = file.name;
            const reader = new FileReader();
            reader.onload = ev => {
                const wb = XLSX.read(ev.target.result, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(ws);
                data = json.map((row, idx) => ({
                    id: idx,
                    order: row['შეკვეთა'] || row['Order'] || '',
                    receiver: row['მიმღები'] || row['Receiver'] || '',
                    courier: row['კურიერი'] || row['Courier'] || '',
                    type: row['ტემპი'] || row['Type'] || '',
                    status: 'ასაგროვებელი',
                    statusChangedDate: null
                }));
                saveData();
                populateCourierFilter();
                applyFilters();
                updateStats();
            };
            reader.readAsBinaryString(file);
        });

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function populateCourierFilter() {
            const couriers = [...new Set(data.map(d => d.courier))].filter(Boolean).sort();
            const sel = document.getElementById('filterCourier');
            sel.innerHTML = '<option value="">ყველა კურიერი</option>';
            couriers.forEach(c => {
                const o = document.createElement('option');
                o.value = c; o.textContent = c;
                sel.appendChild(o);
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const header = document.getElementById('tableHeader');
            if (currentView === 'history') {
                header.innerHTML = `<th>შეკვეთა</th><th>მიმღები</th><th>კურიერი</th><th>ტემპი</th><th>სტატუსი</th><th>შეცვლის თარიღი</th>`;
            } else {
                header.innerHTML = `<th>შეკვეთა</th><th>მიმღები</th><th>კურიერი</th><th>ტემპი</th><th>სტატუსი</th>`;
            }
            if (filteredData.length === 0) {
                const colspan = currentView === 'history' ? 6 : 5;
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="empty-state"><h3>მონაცემები არ მოიძებნა</h3><p>სცადეთ ფილტრების შეცვლა</p></td></tr>`;
                return;
            }
            tbody.innerHTML = filteredData.map(item => {
                const cls = item.status === 'აგროვებული' ? 'status-collected' : 'status-collect';
                const dateCol = currentView === 'history'
                    ? `<td class="date-column">${item.statusChangedDate || '-'}</td>`
                    : '';
                const badge = `<span class="status-badge ${cls}" onclick="${currentView==='dashboard' ? `toggleStatus(${item.id})` : ''}">${item.status}</span>`;
                return `<tr><td>${item.order}</td><td>${item.receiver}</td><td>${item.courier}</td><td>${item.type}</td><td>${badge}</td>${dateCol}</tr>`;
            }).join('');
        }

        function toggleStatus(id) {
            const item = data.find(d=>d.id===id);
            if (item && currentView==='dashboard') {
                const old = item.status;
                item.status = old==='ასაგროვებელი'?'აგროვებული':'ასაგროვებელი';
                if (old !== item.status) {
                    const now = new Date();
                    item.statusChangedDate = now.toLocaleDateString('ka-GE')+' '+now.toLocaleTimeString('ka-GE',{hour:'2-digit',minute:'2-digit'});
                }
                saveData();
                applyFilters();
                updateStats();
            }
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
            event.target.classList.add('active');
            applyFilters();
        }

        function updateStats() {
            document.getElementById('totalOrders').textContent = data.length;
            document.getElementById('toCollectOrders').textContent = data.filter(d=>d.status==='ასაგროვებელი').length;
            document.getElementById('collectedOrders').textContent = data.filter(d=>d.status==='აგროვებული').length;
        }

        function applyFilters() {
            const of = document.getElementById('filterOrder').value.toLowerCase().trim();
            const rf = document.getElementById('filterReceiver').value.toLowerCase().trim();
            const cf = document.getElementById('filterCourier').value;
            const sf = document.getElementById('filterStatus').value;
            let arr = [...data];
            if (currentView==='dashboard') arr = arr.filter(d=>d.status==='ასაგროვებელი');
            filteredData = arr.filter(d => 
                (!of || d.order.toLowerCase().includes(of)) &&
                (!rf || d.receiver.toLowerCase().includes(rf)) &&
                (!cf || d.courier === cf) &&
                (!sf || d.status === sf)
            );
            renderTable();
        }

        function clearAllFilters() {
            ['filterOrder','filterReceiver','filterCourier','filterStatus'].forEach(id=>document.getElementById(id).value='');
            applyFilters();
        }

        ['filterOrder','filterReceiver'].forEach(id => {document.getElementById(id).addEventListener('input',applyFilters);});
        ['filterCourier','filterStatus'].forEach(id => {document.getElementById(id).addEventListener('change',applyFilters);});
    </script>
</body>
</html>
